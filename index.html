<head>
	<title>it's me, mario!</title>
	<meta charset="UTF-8">
	<link rel='icon' href='favicon.ico' type='image/x-icon'/ >
</head>
<body>
<br>
<canvas id="myCanvas" width="1255" height="700" style="border:1px solid #cccccc;"></canvas>
<script type="text/javascript">

////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Mario//////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Mario
{
	constructor(model, x, y)
	{
		this.type = "Mario";
		this.model = model;
		this.x = x;
		this.prev_x = x;
		this.y = y;
		this.prev_y = y;
		this.w = 60;
		this.h = 95;
		this.mframe = 0;
		this.vvel = 0.0;
		this.facingRight = true;
		this.runningRight = false;
		this.runningLeft = false;
		this.onTop = false;
		this.sideCollide = false;
		this.type = "Mario";

		//load mario pics
		this.marioPics = [];
		for(let i = 0; i < 10; i++)
		{
			this.marioPics[i] = new Image();
		}
		this.marioPics[0].src = "mario1.png";
		this.marioPics[1].src = "mario2.png";
		this.marioPics[2].src = "mario3.png";
		this.marioPics[3].src = "mario4.png";
		this.marioPics[4].src = "mario5.png";
		this.marioPics[5].src = "mario1left.png";
		this.marioPics[6].src = "mario2left.png";
		this.marioPics[7].src = "mario3left.png";
		this.marioPics[8].src = "mario4left.png";
		this.marioPics[9].src = "mario5left.png";
	}

	notePrevious()
	{
		this.prev_x = this.x;
		this.prev_y = this.y;
	}

	collision(x, y, w, h)
  {
    if (this.x + this.w <= x)
      return false;
    if (this.x >= x + w)
      return false;
    if (this.y + this.h <= y)
      return false;
    if (this.y >= y + h)
      return false;

    return true;
  }

	leaveBlock(x, y, w, h)
  {
    if (this.y + this.h > y && this.prev_y + this.h <= y) //collision from the top
    {
      this.vvel = 0;
      this.y = y - this.h;
      this.onTop = true;
    }
    if (this.y < y + h && this.prev_y >= y + h) //collision from the bottum
    {
      this.y = y + h;
      this.vvel = 0.1;
    }
    if (this.x + this.w > x && this.prev_x + this.w <= x) //collision from the left
    {
      this.sideCollide = true;
      this.runningRight = false;
      this.model.scrollPos = x - this.model.startPos - this.w;
			this.model.bScrollPos -= 2;
      this.x = x - this.w;
    }
    if ( this.x < x + w && this.prev_x >= x + w) //collision from the right
    {
      this.sideCollide = true;
      this.runningLeft = false;
      this.model.scrollPos = x - this.model.startPos + w;
			this.model.bScrollPos += 2;
      this.x = x + w;
    }
  }

	drawMe(ctx)
	{
		//animate mario
	  if (this.facingRight) //if he's facing right, animate right
	  {
	    this.mframe++; if (this.mframe > 4) this.mframe = 0;

      //if keyRight and mario is on a surface, draw him running
	    if(this.runningRight && (this.onTop == true || this.y == this.model.ground))
	      ctx.drawImage(this.marioPics[this.mframe], this.model.startPos, this.y);

	    //else draw him standing still
	    else ctx.drawImage(this.marioPics[3], this.model.startPos, this.y);
	  }
	  else //if he's facing left,  animate left
	  {
	    this.mframe++; if (this.mframe < 5 || this.mframe > 9) this.mframe = 5;

	    //if keyLeft and mario is on a surface, draw him running
	    if(this.runningLeft && (this.onTop == true || this.y == this.model.ground))
	      ctx.drawImage(this.marioPics[this.mframe], this.model.startPos, this.y);

	    //else draw him standing still
	    else ctx.drawImage(this.marioPics[8], this.model.startPos, this.y);
	  }
	}

	update()
	{
		this.onTop = false;
    this.sideCollide = false;
    this.vvel += 3.14159;
    this.y += this.vvel;

    if(this.runningRight)
    {
      this.x+=12;
      this.facingRight = true;
      this.model.scrollPos += 12;
			this.model.bScrollPos += 2;
    }

    if(this.runningLeft)
    {
      this.x-=12;
      this.facingRight = false;
      this.model.scrollPos -= 12;
			this.model.bScrollPos -= 2;
    }

    if(this.y > this.model.ground)//if he's on the ground, put him there
    {
      this.y = this.model.ground;
      this.vvel = 0;
    }

		//collision detection
		for(let i = 0; i < this.model.sprites.length; i++)
		{
			let s = this.model.sprites[i];

			if(s.type != "Mario" && s.type != "Coin")
			{
				if(this.x + this.w == s.x || this.x == s.x + s.w)
					this.sideCollide = true;

				if(this.collision(s.x, s.y, s.w, s.h))
					this.leaveBlock(s.x, s.y, s.w, s.h);
			}
		}
	}
}



////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Brick//////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Brick
{
	constructor(model, x, y)
	{
		this.type = "Brick";
		this.model = model;
		this.x = x;
		this.y = y;
		this.w = 100;
		this.h = 100;
		this.brickPic = new Image();
		this.brickPic.src = "brickPicSmall.png";
	}

	drawMe(ctx)
	{
		ctx.drawImage(this.model.brick1.brickPic, this.model.brick1.x - this.model.scrollPos, this.model.brick1.y);
		ctx.drawImage(this.model.brick2.brickPic, this.model.brick2.x - this.model.scrollPos, this.model.brick2.y);
	}

	update()
	{
	}
}



////////////////////////////////////////////////////////////////////////////////
//////////////////////////////CoinBlock/////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class CoinBlock
{
	constructor(model, x, y)
	{
		this.type = "CoinBlock";
		this.model = model;
		this.x = x;
		this.y = y;
		this.w = 88;
		this.h = 88;
		this.coinCount = 5;
		this.blockPic = new Image();
		this.emptyBlockPic = new Image();
		this.blockPic.src = "coinBlock2.png";
		this.emptyBlockPic.src = "emptyCoinBlock2.png";
	}

	getRandom()
	{
		return Math.random() * (50-1) + 1 ;
	}

	drawMe(ctx)
	{
		if(this.model.coinBlock1.coinCount > 0)
			ctx.drawImage(this.model.coinBlock1.blockPic, this.model.coinBlock1.x - this.model.scrollPos, this.model.coinBlock1.y);
		else
			ctx.drawImage(this.model.coinBlock1.emptyBlockPic, this.model.coinBlock1.x - this.model.scrollPos, this.model.coinBlock1.y);
		if(this.model.coinBlock2.coinCount > 0)
			ctx.drawImage(this.model.coinBlock2.blockPic, this.model.coinBlock2.x - this.model.scrollPos, this.model.coinBlock2.y);
		else
			ctx.drawImage(this.model.coinBlock2.emptyBlockPic, this.model.coinBlock2.x - this.model.scrollPos, this.model.coinBlock2.y);
	}

	update()
	{
		//if mario's head bumps the bottum of the block
    if (this.model.mario.y == this.y + this.h && this.model.mario.x + this.model.mario.w > this.x && this.model.mario.x < this.x + this.w)
    {
      this.model.mario.vvel = 0.1;
      if(this.coinCount > 0)
      {
        this.vvelocity = -30.0;
        this.n = this.getRandom();
        if(this.n > 25)
          this.hvelocity = this.n%15.0;
        else
          this.hvelocity = -this.n%15.0;

				this.model.sprites.push(new Coin(this.hvelocity, this.vvelocity, this.x, this.y - 40, this.model));

        this.coinCount--;
      }
    }
	}
}



////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Coin///////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Coin
{
	constructor(hvel, vvel, x, y, m)
  {
		this.type = "Coin";
		this.model = m;
		this.x = x;
		this.y = y;
		this.w = 0;
		this.h = 0;
    this.hvel = hvel;
    this.vvel = vvel;

		this.coinPic = new Image();
		this.coinPic.src = "coin.png";
  }

	drawMe(ctx)
	{
		for(let i = 0; i < this.model.sprites.length; i++)
		{
			let s = this.model.sprites[i];
			if(s.type == "Coin")
				ctx.drawImage(this.coinPic, s.x - this.model.scrollPos, s.y);
		}
	}

  update()
  {
    this.vvel+=3.14159;
    this.y += this.vvel;
    this.x += this.hvel;
  }
}



////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////Lava/////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Lava
{
	constructor(x, y, w, h, model)
	{
		this.x = x;
		this.y = y;
		this.w = w;
		this.h = h;
		this.model = model;
	}

	drawMe(ctx)
	{
		ctx.beginPath();
		ctx.rect(this.x - this.model.scrollPos, this.y, this.w, this.h);
		ctx.fillStyle = "red";
		ctx.fill();
	}

	update()
	{
	}
}



////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Model//////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Model
{
	constructor()
	{
		this.scrollPos = 0;
		this.bScrollPos = 0;
		this.startPos = 550;
		this.ground = 455;

		this.mario = new Mario(this, this.startPos, this.ground);
		this.brick1 = new Brick(this, 350, 350);
		this.brick2 = new Brick(this, 1000, 280);
		this.coinBlock1 = new CoinBlock(this, 150, 250);
		this.coinBlock2 = new CoinBlock(this, 1300, 200);
		this.lava = new Lava(2000, 550, 300, 300, this);

		this.sprites = [];
		this.sprites.push(this.mario);
		this.sprites.push(this.brick1);
		this.sprites.push(this.brick2);
		this.sprites.push(this.coinBlock1);
		this.sprites.push(this.coinBlock2);
		this.sprites.push(this.lava);
	}

	update()
	{
		for(let i = 0; i < this.sprites.length; i++)
		{
			let s = this.sprites[i];
			s.update();
		}
	}
}



////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////View///////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class View
{
	constructor(model)
	{
		this.model = model;
		this.backgroundPic = new Image();
		this.backgroundPic.src = "scaledBackground.png";
		this.canvas = document.getElementById("myCanvas");
	}

	update()
	{
		//clear the screen
		let ctx = this.canvas.getContext("2d");
		ctx.clearRect(0, 0, 1255, 700);

		//draw the sky
		ctx.beginPath();
		ctx.rect(0, 0, 1500, 1000);
		ctx.fillStyle = 'rgb(55, 201, 200)';
		ctx.fill();

		//draw the background
		ctx.drawImage(this.backgroundPic, 100 - this.model.bScrollPos, -500);

		//draw the ground
		ctx.beginPath();
		ctx.rect(0, this.model.startPos, 1500, 1000);
		ctx.fillStyle = "green";
		ctx.fill();

		//draw the sprites
		for(let i = 0; i < this.model.sprites.length; i++)
		{
			this.model.sprites[i].drawMe(ctx);
		}
	}
}



////////////////////////////////////////////////////////////////////////////////
//////////////////////////////Controller////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Controller
{
	constructor(model, view)
	{
		this.model = model;
		this.view = view;
		this.key_right = false;
		this.key_left = false;
		this.key_space = false;
		let self = this;
		document.addEventListener('keydown', function(event) { self.keyDown(event); }, false);
		document.addEventListener('keyup', function(event) { self.keyUp(event); }, false);
	}

	keyDown(event)
	{
		if(event.keyCode == 39)
			this.key_right = true;

		else if(event.keyCode == 37)
			this.key_left = true;

		else if(event.keyCode == 32)
		if(this.model.mario.onTop == true || this.model.mario.y == this.model.ground)
			this.key_space = true;
	}

	keyUp(event)
	{
		if(event.keyCode == 39) this.key_right = false;
		else if(event.keyCode == 37) this.key_left = false;
		else if(event.keyCode == 32) this.key_space = false;
	}

	update()
	{
		this.model.mario.notePrevious();
    this.model.mario.runningLeft = false;
    this.model.mario.runningRight = false;

    if(this.key_right)//make mario run right
		{
      this.model.mario.runningRight = true;
    }

		if(this.key_left)//make Mario run left
		{
      this.model.mario.runningLeft = true;
    }

		if(this.key_space)//make mario jump
		{
      if (this.model.mario.vvel == 0)
      {
        this.model.mario.vvel = -40;
      }
		}
	}
}



////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Game///////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
class Game
{
	constructor()
	{
		this.model = new Model();
		this.view = new View(this.model);
		this.controller = new Controller(this.model, this.view);
	}

	onTimer()
	{
		this.controller.update();
		this.model.update();
		this.view.update();
	}
}


let game = new Game();
let timer = setInterval(function() { game.onTimer(); }, 40);

</script>
</body>
